input {
  file {
    type => "nginx-access"
    path => "/usr/share/logstash/container-logs/nginx-access.log*"
    mode => "read"
    start_position => "beginning"
    file_completed_action => "log"
    file_completed_log_path => "/usr/share/logstash/logs/completed.log"
  }
}

## Add your filters / logstash plugins configuration here
filter {
  grok {
    patterns_dir => "/usr/share/logstash/patterns"
    match => { "message" => "%{PANTHEON}" }
    add_tag => ["nginx_access"]
    remove_field => "message"
  }
  if "_grokparsefailure" in [tags] {
    drop { }
  }
  geoip {
    source => "clientip"
  }
  mutate {
    add_field => { "read_timestamp" => "%{@timestamp}" }
  }
  date {
    match => [ "time", "dd/MMM/yyyy:HH:mm:ss Z" ]
    remove_field => "time"
  }
  fingerprint {
    concatenate_all_fields => true
    target => "[@metadata][fingerprint]"
    method => "MURMUR3"
  }
}

output {
  elasticsearch {
    hosts => "elasticsearch:9200"
    user => "elastic"
    password => "changeme"
    index => "logstash-%{+YYYY.MM}"
    document_id => "%{[@metadata][fingerprint]}"
  }
}
